name: "E2E k8s testing"

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main
      - feature/*
      - chore/*
      - fix/*
      - refactor/*

  workflow_dispatch:
    inputs:
      logLevel:
        description: 'Log level' 
        type: choice
        options:
        - info
        - warning
        - debug 
        default: debug
        required: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/adnilim/kube-ns-suspender

jobs:
  changes:
    runs-on: ubuntu-latest
    permissions:
      statuses: write
      pull-requests: read
      contents: read
    outputs:
      run: ${{ steps.filter.outputs.run }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Check changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          # TODO: Once poc validated, add:
          # - '.github/workflows/test-k8s.yaml'
          filters: |
            run:
              - 'main.go'
              - 'go.*'
              - '**/*.go'
              - '**/*.html'
              - 'tests/*'
              - 'tools/*'
              - 'Dockerfile'
              - 'manifests/dev'
              - 'manifests/testing-namespace'
      
      # https://github.community/t/feature-request-conditional-required-checks/16761/28
      - name: Update GH commit status
        if: (github.event_name == 'pull_request' && steps.filter.outputs.run != 'true')
        env:
          # Required for gh api call
          GITHUB_TOKEN: "${{ github.token }}"
        run: |
          gh api "/repos/{owner}/{repo}/statuses/${{ github.event.pull_request.head.sha }}" \
            -f context="E2E k8s testing / build-image" \
            -f state="success"
          for version in 1.31.4 1.32.2 1.33.0 1.34.0; do
            gh api "/repos/{owner}/{repo}/statuses/${{ github.event.pull_request.head.sha }}" \
              -f context="E2E k8s testing / test-e2e (k8s ${version})" \
              -f state="success"
          done

  build-image:
    needs: changes
    # Run if: (1) code changes detected, OR (2) a tag was pushed
    if: |
      needs.changes.outputs.run == 'true' ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Get current date
        id: date
        run: echo "BUILD_DATE=$(date +'%Y-%m-%d_%H:%M:%ST%Z')" >> $GITHUB_ENV

      - name: Extract metadata from Git and GitHub for Docker
        id: meta
        uses: docker/metadata-action@98669ae865ea3cffbcbaa878cf57c20bbf1c6c38
        with:
          images: ${{ env.IMAGE_NAME }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: BuildDocker image
        uses: docker/build-push-action@ad44023a93711e3deb337508980b4b5e9bcdc5dc
        with:
          context: .
          push: false
          load: false
          tags: ${{ env.IMAGE_NAME }}:latest
          outputs: type=docker,dest=/tmp/kube-ns-suspender_oci.tar
          build-args: |
            VERSION=${{ steps.meta.outputs.tags }}
            BUILD_DATE=${{ env.BUILD_DATE }}

      - name: Upload container image
        uses: actions/upload-artifact@v3
        with:
          name: kube-ns-suspender_oci
          path: /tmp/kube-ns-suspender_oci.tar
          retention-days: 2

  test-e2e:
    needs:
      - changes
      - build-image
    # Run if: (1) code changes detected, OR (2) a tag was pushed
    if: |
      needs.changes.outputs.run == 'true' ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
    runs-on: ubuntu-latest
    strategy:
      matrix:
        k8s-version: ['1.31.4', '1.32.2', '1.33.0', '1.34.0']
      fail-fast: false
    name: test-e2e (k8s ${{ matrix.k8s-version }})
    steps:
      # Needed to get config and tests
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: kube-ns-suspender_oci
          path: /tmp

      - name: Load image into docker
        run: |
          docker load --input /tmp/kube-ns-suspender_oci.tar
          docker image ls -a

      - name: Setup KinD
        uses: helm/kind-action@v1
        with:
          version: "v0.24.0"
          node_image: kindest/node:v${{ matrix.k8s-version }}
          cluster_name: kns-test

      - name: Load image into kind
        run: |
          kind load docker-image ghcr.io/adnilim/kube-ns-suspender:latest

      - name: Setup Testing
        run: ./tests/scripts/setup.sh

      # TODO: Try to use the Makefile targets
      - name: Testing
        run: time bats ./tests/

      - name: Collect logs
        if: ${{ always() }}
        run: |
          echo "---> DETIK logs"
          cp -va /tmp/detik tmp/
          cat tmp/*.log tmp/*.debug
          echo "---> KIND logs"
          mkdir -vp tmp/kind
          kind export logs tmp/kind/

      - name: Archive test logs
        if: ${{ always() }}
        uses: actions/upload-artifact@v3
        with:
          name: tests-logs-k8s-${{ matrix.k8s-version }}
          path: tmp/
          retention-days: 5

  publish-image:
    needs:
      - changes
      - test-e2e
    # Run if: (1) code changes detected and not a PR, OR (2) a tag was pushed
    if: |
      (needs.changes.outputs.run == 'true' && github.event_name != 'pull_request') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))
    runs-on: ubuntu-latest
    # Permissions for the Built-in, auto-loaded secrets.GITHUB_TOKEN
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Get current date
        id: date
        run: echo "BUILD_DATE=$(date +'%Y-%m-%d_%H:%M:%ST%Z')" >> $GITHUB_ENV

      - name: Extract version and generate tags
        id: version
        run: |
          TAGS="${IMAGE_NAME}:latest"

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Remove 'refs/tags/' prefix and 'v' prefix from version
            VERSION="${GITHUB_REF#refs/tags/}"
            VERSION="${VERSION#v}"
            echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

            # Generate semantic version tags: X.Y.Z, X.Y, X
            TAGS="${IMAGE_NAME}:${VERSION},${IMAGE_NAME}:latest"

            # Add X.Y tag if version has patch (e.g., 3.0.2 -> add 3.0)
            if [[ $VERSION =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
              MAJOR="${BASH_REMATCH[1]}"
              MINOR="${BASH_REMATCH[2]}"
              TAGS="${TAGS},${IMAGE_NAME}:${MAJOR}.${MINOR}"
              TAGS="${TAGS},${IMAGE_NAME}:${MAJOR}"
            fi
          else
            echo "VERSION=latest" >> $GITHUB_OUTPUT
          fi

          echo "TAGS=${TAGS}" >> $GITHUB_OUTPUT
          echo "Generated tags: ${TAGS}"

      - name: Build and push multi-architecture image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.version.outputs.TAGS }}
          build-args: |
            VERSION=${{ steps.version.outputs.VERSION }}
            BUILD_DATE=${{ env.BUILD_DATE }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
